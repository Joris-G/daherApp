import{b as P}from"./chunk-NHMY2DF4.js";import{G as a,J as o,Jb as I,O as A,Rb as s,Yc as k,c as v,d as c,i as u,l as d,me as b,ne as p,o as f,pe as l,vb as y,x as M}from"./chunk-U2GCEKKH.js";import{h as S}from"./chunk-B4AJQJMI.js";var D=(()=>{class i{requestService;alertService;constructor(t,e){this.requestService=t,this.alertService=e}getKitById(t){return this.requestService.createGetRequest(`${s.moldingApi}datas_kits?page=1&idMM=${t}`).pipe(d(e=>{if(e.length===0)throw this.alertService.simpleAlert("Erreur","Kit non trouv\xE9","Veuillez r\xE9-essayer"),new Error(`aucun kit ne correspond au num\xE9ro : ${t}`);return{id:e[0].id,aCuirAv:e[0].ACuirAv,aDrapAv:e[0].ADrapAv,createdAt:e[0].createdAt,decongel:e[0].Decongel,designationSAP:e[0].DesignationSAP,idMM:e[0].idMM,lotSAP:e[0].LotSAP,peremptionMoins18:e[0].PeremptionMoins18,referenceSAP:e[0].ReferenceSAP,status:e[0].status,tackLife:e[0].TackLife,timeOut:e[0].TimeOut,updateAt:e[0].updateAt}}))}isPerim(t,e){return new Date(t)<new Date(e)}kitIsInKits(t,e){return e.some(r=>r.idMM===t.idMM)}getIri(t){return`/api/datas_kits/${t.id}`}updateKit(t){return this.requestService.createPatchRequest(`${s.apiServer}/${s.moldingApi}/datas_kits/${t.id}`,t)}handleError(t,e="error"){return this.alertService.simpleAlert("Erreur Kit","Kit non conforme","Il semble y avoir un probl\xE8me avec le kit scann\xE9. V\xE9rifier le kit et essayer de nouveau."),u()}static \u0275fac=function(e){return new(e||i)(o(l),o(p))};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var m=class{id;kits=[];moldingDay=new Date;createdBy;outillage;aCuireAv;aDraperAv;matPolym;matDrap;woList;updatedAt;isActive=!1;userCreat;OT;materialSupplementary=[];getIri(){return`api/moldings/${this.id}`}},h=class{moldingStatus=new c({moldingStatus:!1,kitStatus:!1,toolStatus:!1});toolStatus;kitStatus;constructor(n=!1,t=!1){console.log("new molding status"),this.kitStatus=t,this.toolStatus=n,this.upDateMoldingStatus()}setToolStatus(n){this.toolStatus=n,this.upDateMoldingStatus()}setKitStatus(n){this.kitStatus=n,this.upDateMoldingStatus()}getToolStatus(){return this.toolStatus}getKitStatus(){return this.kitStatus}upDateMoldingStatus(){let n=this.kitStatus&&this.toolStatus;this.moldingStatus.next({moldingStatus:n,kitStatus:this.kitStatus,toolStatus:this.toolStatus})}};var C=(()=>{class i{requestService;constructor(t){this.requestService=t}addOne(t){return this.requestService.createPostRequest(`${s.moldingApi}additional_materials`,t)}static \u0275fac=function(e){return new(e||i)(o(l))};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var q=(()=>{class i{getCoreByBatchNumber(t){let e=t.substring(5).split("~");return e={partNumber:e[0],batch1:e[1],batch2:e[2]},u({idCore:1,batchNumber:e})}getIri(t){return`/api/additional_materials/${t.id}`}static \u0275fac=function(e){return new(e||i)};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var et=(()=>{class i{kitService;matService;toolService;requestService;coreService;alertService;navCtrl;loadingService;http;molding=new m;molding$=new c(this.molding);toolStatus=new v;moldingStatus$;moldingStatus=new h;constructor(t,e,r,w,T,$,K,L,O){this.kitService=t,this.matService=e,this.toolService=r,this.requestService=w,this.coreService=T,this.alertService=$,this.navCtrl=K,this.loadingService=L,this.http=O,this.moldingStatus$=this.moldingStatus.moldingStatus.asObservable()}initMolding(){let t=new m;this.updateMoldings(t)}setToolStatus(t){let e;t?e=t:e=!!this.molding.OT,this.moldingStatus.setToolStatus(e)}setKitStatus(){let t=this.molding.kits.length>0;this.moldingStatus.setKitStatus(t)}removeKit(t){this.molding.kits.splice(t,1),this.updateDates(),this.updateMoldings()}saveMolding(t){this.loadingService.startLoading("Sauvegarde du moulage en cours"),(this.molding.id?this.patchMolding():this.postMolding()).subscribe({next:r=>{this.loadingService.stopLoading(),this.molding=r},error:r=>{this.loadingService.stopLoading()}})}loadMolding(t){this.loadingService.startLoading("Patienter pendant le chargement du moulage"),this.getMoldingById(t).subscribe(e=>{this.updateMoldings(e),this.loadingService.stopLoading()},e=>{console.error(e),this.loadingService.stopLoading(),this.alertService.simpleAlert("Erreur moulage","Erreur de r\xE9cup\xE9ration du moulage",`Le moulage <strong>${t}</strong> n'existe pas`)})}updateDates(){if(this.molding.aCuireAv=null,this.molding.aDraperAv=null,this.molding.kits.length<=0)return;this.molding.matPolym=this.molding.kits.reduce((e,r)=>e.aCuirAv>r.aCuirAv?r:e),this.molding.matDrap=this.molding.kits.reduce((e,r)=>e.aDrapAv>r.aDrapAv&&!r.layupDate?r:e);let t=this.molding.kits.reduce((e,r)=>e.peremptionMoins18>r.peremptionMoins18?r:e);this.molding.matPolym.aCuirAv<t.peremptionMoins18?this.molding.aCuireAv=this.molding.matPolym.aCuirAv:this.molding.aCuireAv=t.peremptionMoins18,this.molding.matDrap.aDrapAv<t.peremptionMoins18?this.molding.aDraperAv=this.molding.matDrap.aDrapAv:this.molding.aDraperAv=t.peremptionMoins18}getMoldingById(t){return this.requestService.createGetRequest(`${s.moldingApi}moldings/${t}`).pipe(d(e=>(e.kits=this.moldingServerToMoldingObject(e),e)))}addKit(t){this.kitService.kitIsInKits(t,this.molding.kits)?(this.alertService.presentToast("Le kit a d\xE9j\xE0 \xE9t\xE9 scann\xE9"),console.error("kit en doublon")):(this.molding.kits.push(t),this.updateDates(),this.updateMoldings())}addNida(t){this.molding.materialSupplementary.push(t),this.updateMoldings()}addTool(t){this.molding.OT=t,this.alertService.presentToast("Outillage associ\xE9 !"),this.setToolStatus(!0),this.updateMoldings()}updateMoldings(t){t&&(this.molding=t),this.updateDates(),this.setKitStatus(),this.setToolStatus(),this.molding$.next(this.molding)}cancelMolding(){return S(this,null,function*(){(yield this.alertService.presentAlertConfirm("Vous allez annuler ce moulage","Etes vous sur ?"))&&(this.molding.isActive=!1,this.updateMoldings())})}saveOtherMaterials(){return f(this.molding.materialSupplementary.map(t=>this.matService.addOne(t)))}postMolding(){let t=this.toIri();return this.requestService.createPostRequest(`${s.moldingApi}moldings`,t,!0)}patchMolding(){let t=this.toIri(),e=`${s.moldingApi}moldings/${t.id}`;return this.requestService.createPatchRequest(e,t).pipe(M(()=>this.loadingService.stopLoading()))}toIri(){let t=this.molding;return{id:t.id,kits:t.kits.map(e=>this.kitService.getIri(e)),materialSupplementary:t.materialSupplementary.map(e=>this.coreService.getIri(e)),moldingDay:t.moldingDay,outillage:t.OT?this.toolService.getIri(t.OT):null,aCuireAv:t.aCuireAv,aDraperAv:t.aDraperAv,matPolym:this.kitService.getIri(t.matPolym),matDrap:this.kitService.getIri(t.matDrap)}}moldingServerToMoldingObject(t){return t.kits.map(e=>({aCuirAv:e.ACuirAv,aDrapAv:e.ADrapAv,createdAt:e.createdAt,decongel:e.Decongel,designationSAP:e.DesignationSAP,id:e.id,idMM:e.idMM,lotSAP:e.LotSAP,peremptionMoins18:e.PeremptionMoins18,referenceSAP:e.ReferenceSAP,status:e.status,tackLife:e.TackLife,timeOut:e.TimeOut}))}printMolding(){this.navCtrl.navigateForward(["molding/print-molding-sheet",this.molding.id])}static \u0275fac=function(e){return new(e||i)(o(D),o(C),o(P),o(l),o(q),o(p),o(k),o(b),o(I))};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var st=(()=>{class i{transform(t){if(t)return y(t,"dd/MM/yyyy \xE0 HH:mm","FR")}static \u0275fac=function(e){return new(e||i)};static \u0275pipe=A({name:"DateHeure",type:i,pure:!0,standalone:!0})}return i})();export{D as a,q as b,et as c,st as d};
